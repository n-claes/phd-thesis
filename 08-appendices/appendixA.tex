\chapter{Matrix elements} \label{ch: appendix1}
Here we provide the matrix elements in the finite element representation as used by {\legolas} as supplementary material. All matrix elements are given in MHD with selfgravity included.
As done in Equation \eqref{eq: matrix_splitting} we write the different physical contributions as a dedicated matrix, where $\bmat$ and $\amat$ indicate the ideal terms (including external gravity), $\flowmat$ the flow terms, $\etamat$ the resistive terms, $\coolmat$ the radiative cooling terms, $\condmat$ the thermal conduction terms and $\sgravmat$ the selfgravity terms. No Hall or viscosity terms will be given here. As before, indices correspond to the location in the state vector, that is,
\begin{equation}
  \statevec = \left(\rho_1, v_1, v_2, v_3, T_1, a_1, a_2, a_3\right)
   = \left(x^1, x^2, x^3, x^4, x^5, x^6, x^7, x^8\right),
\end{equation}
and in the case of selfgravity we have a ninth index $x^9$ corresponding to the perturbed gravitational potential $\Phi_1$.

\subsubsection{Matrix elements continuity equation}
{
  % \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(1, 1) &= \int \hj{1}\hk{1}  &\\
    \amat(1, 2) &= -\int \rho_0'\hj{1}\hk{2}  - \int \rho_0 \hj{1}\dhk{2} &\\
    \amat(1, 3) &= \int \rho_0 k_2 \hj{1}\hk{3} &\\
    \amat(1, 4) &= \int \rho_0 k_3 \hj{1}\hk{4} &\\
    \flowmat(1, 1) &= \int\Bigl(\Vplus - iv_{01}'\Bigr)\hj{1}\hk{1} - \int i v_{01}\hj{1}\dhk{1} &\\
  \end{flalign*}
}

\subsubsection{Matrix elements momentum-1 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(2, 2) &= \int \rho_0 \hj{2}\hk{2}  &\\
    %
    \amat(2, 1) &= T_0\hj{2}\hk{1}
      - \int \frac{\eps'}{\eps}T_0\hj{2}\hk{1}
      - \int T_0\dhj{2}\hk{1} + \int g\hj{2}\hk{1} &\\
    %
    \amat(2, 5) &= \rho_0\hj{2}\hk{5} - \int \frac{\eps'}{\eps}\rho_0 \hj{2}\hk{5} - \int \rho_0 \dhj{2}\hk{5} &\\
    %
    \amat(2, 6) &= -\eps\Gmin\hj{2}\hk{6}
      + \int\eps'\left(k_3B_{02} + \frac{k_2}{\eps}B_{03}\right)\hj{2}\hk{6}
      + \int \eps\Gmin\dhj{2}\hk{6} &\\
    %
    \amat(2, 7) &= B_{03}\hj{2}\dhk{7}
      - \int k_3\Fplus\hj{2}\hk{7}
      - \int\frac{\eps'}{\eps}B_{03}\hj{2}\dhk{7}
      - \int B_{03}\dhj{2}\dhk{7} &\\
    %
    \amat(2, 8) &= -\eps B_{02}\hj{2}\dhk{8}
      + \int k_2\Fplus\hj{2}\hk{8}
      - \int \eps'B_{02}\hj{2}\dhk{8}
      + \int\eps B_{02}\dhj{2}\dhk{8} &\\
    %
    \sgravmat(2, 9) &= \int \eps \rho_0 \hj{2}\dhk{9} &\\
    %
    \flowmat(2, 1) &= \int\left(v_{01}v_{01}' - \frac{\eps'}{\eps}v_{02}^2\right)\hj{2}\hk{1} &\\
    %
    \flowmat(2, 2) &= -i\rho_0v_{01}\hj{2}\hk{2}
      + \int\left[\rho_0\Vplus + \left(\frac{\eps'}{\eps}\rho_0 + \rho_0'\right)iv_{01}\right]\hj{2}\hk{2}
      + \int i\rho_0v_{01}\dhj{2}\hk{2} &\\
    %
    \flowmat(2, 3) &= -\int 2\eps'\rho_0 v_{02}\hj{2}\hk{3}
  \end{flalign*}
}

\subsubsection{Matrix elements momentum-2 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(3, 3) &= \int \eps \rho_0\hj{3}\hk{3}	&\\
    %
    \amat(3, 1) &= \int \frac{k_2}{\eps}T_0\hj{3}\hk{1} &\\
    %
    \amat(3, 5) &= \int \frac{k_2}{\eps}\rho_0\hj{3}\hk{5} &\\
    %
    \amat(3, 6) &= i\eps k_3B_{01}\hj{3}\hk{6}
      - \int i\eps k_3 B_{01}\dhj{3}\hk{6}
      - \int \left(\frac{k_2^2}{\eps} + \eps k_3^2\right) B_{03}\hj{3}\hk{6}	&\\
    %
    \amat(3, 7) &= \int\frac{k_3}{\eps}\Bigl((\eps B_{02})' - i k_2 B_{01}\Bigr)\hj{3}\hk{7}
      + \int \frac{k_2}{\eps}B_{03}\hj{3}\dhk{7} &\\
    \amat(3, 8) &= -i\eps B_{01}\hj{3}\dhk{8}
      + \int \frac{k_2}{\eps}\Bigl(i k_2 B_{01} - (\eps B_{02})'\Bigr) \hj{3}\hk{8}
      + \int \eps k_3 B_{03}\hj{3}\dhk{8} \\
      &+ \int i\eps B_{01}\dhj{3}\dhk{8} &\\
    %
    \sgravmat(3, 9) &= \int \rho_0 k_2 \hj{3}\hk{9} &\\
    %
    \flowmat(3, 1) &= -\int \frac{(\eps v_{02})'}{\eps}iv_{01}\hj{3}\hk{1} &\\
    %
    \flowmat(3, 2) &= -\int \frac{(\eps v_{02})'}{\eps}\rho_0\hj{3}\hk{2} &\\
    %
    \flowmat(3, 3) &= \int \rho_0\Bigl(-i\eps'v_{01} + \eps \Vplus\Bigr)\hj{3}\hk{3}
      - \int i\eps\rho_0v_{01}\hj{3}\dhk{3}
  \end{flalign*}
}

\subsubsection{Matrix elements momentum-3 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(4, 4) &= \int \rho_0 \hj{4}\hk{4} &\\
    %
    \amat(4, 1) &= \int k_3 T_0 \hj{4}\hk{1} &\\
    %
    \amat(4, 5) &= \int k_3 \rho_0 \hj{4}\hk{5} &\\
    %
    \amat(4, 6) &= -i k_2 B_{01} \hj{4}\hk{6}
      + \int \left[
        i \frac{\eps'}{\eps} k_2 B_{01} + B_{02}\left(\frac{k_2^2}{\eps} + \eps k_3^2\right)
      \right] \hj{4}\hk{6} \\
      &+ \int ik_2 B_{01} \dhj{4}\hk{6} &\\
    %
    \amat(4, 7) &= iB_{01}\hj{4}\dhk{7}
      + \int k_3\Bigl(B_{03}' - ik_3B_{01}\Bigr)\hj{4}\hk{7}
      - \int \frac{1}{\eps} \Bigl(k_2B_{02} + i\eps'B_{01}\Bigr)\hj{4}\dhk{7} \\
      &- \int iB_{01}\dhj{4}\dhk{7} &\\
    %
    \amat(4, 8) &= \int k_2\Bigl(iB_{01}k_3 - B_{03}'\Bigr)\hj{4}\hk{8} - \int \eps k_3 B_{02}\hj{4}\dhk{8} &\\
    %
    \sgravmat(4, 9) &= \int \rho_0 \eps k_3 \hj{4}\hk{9} &\\
    %
    \flowmat(4, 1) &= -\int i v_{01}v_{03}'\hj{4}\hk{1} &\\
    %
    \flowmat(4, 2) &= -\int \rho_0 v_{03}'\hj{4}\hk{2} &\\
    %
    \flowmat(4, 4) &= -i\rho_0 v_{01}\hj{4}\hk{4}
      + \int \left[
        \rho_0\left(\Vplus + iv_{01}'\right) + \left(\frac{\eps'}{\eps}\rho_0 + \rho_0'\right)iv_{01}
      \right]\hj{4}\hk{4} \\
      &+ \int i\rho_0 v_{01} \dhj{4}\hk{4} &\\
  \end{flalign*}
}

\newcommand{\oneminusBoneB}{\left(1 - \frac{B_{01}^2}{B_0^2}\right)}
\newcommand{\kpplus}{\left(\kappapfK{0} + \dkappaperpdB\right)}
\newcommand{\kpplusplus}{
  \left[\oneminusBoneB\dkappaperpdB - \frac{B_{01}^2}{B_0^2}\kappapfK{0}\right]
}

\subsubsection{Matrix elements energy equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(5, 5) &= \int \rho_0 \hj{5}\hk{5} &\\
    %
    \amat(5, 2) &= -\int T_0'\rho_0 \hj{5}\hk{2} - \int \gmone T_0 \rho_0 \hj{5}\dhk{2} &\\
    %
    \amat(5, 3) &= \int \gmone k_2 \rho_0 T_0 \hj{5}\hk{3} &\\
    %
    \amat(5, 4) &= \int \gmone k_3 \rho_0 T_0 \hj{5}\hk{4} &\\
    %
    \flowmat(5, 1) &= -\int i\gmone \frac{\left(\eps v_{01}\right)'}{\eps}T_0 \hj{5}\hk{1} &\\
    %
    \flowmat(5, 5) &= -i \rho_0 v_{01}\hj{5}\hk{5}
      + \int \rho_0\left[\Vplus + iv_{01}' - i\gmone \frac{\left(\eps v_{01}\right)'}{\eps}\right]\hj{5}\hk{5} \\
      &+ \int iv_{01}\left(\frac{\eps'}{\eps}\rho_0 + \rho_0'\right)\hj{5}\hk{5}
      + \int i\rho_0v_{01} \dhj{5}\hk{5} &\\
    %
    \coolmat(5, 1) &= -\int i \gmone \Bigl(\HLF_0 + \rho_0 \dHLFrho\Bigr) \hj{5}\hk{1} &\\
    %
    \coolmat(5, 5) &= -\int i \gmone \rho_0 \dHLFT\hj{5}\hk{5} &\\
    %
    \condmat(5, 1) &= i \gmone T_0' \dkappaperpdrho \oneminusBoneB \hj{5}\hk{1} \\
      &+ \int \gmone T_0'\frac{B_{01}}{B_0^2}\dkappaperpdrho \left(
          \frac{\eps'}{\eps}iB_{01} + \Fplus
        \right) \hj{5}\hk{1} \\
      &- \int i\gmone T_0'\dkappaperpdrho \oneminusBoneB \dhj{5}\hk{1} &\\
    %
    \condmat(5, 5) &=
      \gmone \left[
        -B_{01}\kappapfK{0}\left(2\frac{\eps'}{\eps}iB_{01} + 3\Fplus\right)
        - \frac{\eps'}{\eps}i \skappaperp{0}
      \right]\hj{5}\hk{5} \\
      &+ \gmone i T_0'\left[\frac{B_{01}^2}{B_0^2}\dkappaparadT + \dkappaperpdT\oneminusBoneB\right]\hj{5}\hk{5} &\\
		  &+ i\gmone \left(2B_{01}^2\kappapfK{0} + \skappaperp{0}\right)\hj{5}\dhk{5} \\
		  &+ \gmone \int \left[
        B_{01}\Fplus\kappapfK{0}'
        - i\frac{1}{\eps}\left(\frac{k_2^2}{\eps} + \eps k_3^2\right)\skappaperp{0}
        + \kappapfK{0}\left(B_{01}\Fplus' - i\Fplus^2\right)
      \right]\hj{5}\hk{5} \\
      &- \gmone \int \left[
        \frac{B_{01}}{B_0^2}T_0'\left(\dkappaparadT - \dkappaperpdT\right)\left(
          \frac{\eps'}{\eps}i B_{01} + \Fplus
        \right)
      \right] \hj{5}\hk{5} \\
      &+ \gmone \int \kappapfK{0}B_{01}\frac{\eps'}{\eps}\left(
        2\frac{\eps'}{\eps}i B_{01} + 3\Fplus
      \right)\hj{5}\hk{5}
      - \int 2i\gmone \frac{\eps'}{\eps}B_{01}^2\kappapfK{0} \hj{5}\dhk{5} \\
      &+ \gmone \int \left[
        B_{01}\kappapfK{0}\left(
          2\frac{\eps'}{\eps} i B_{01} + 3\Fplus
        \right) + i\frac{\eps'}{\eps}\skappaperp{0}
      \right] \dhj{5}\hk{5} \\
      &- i \gmone \int T_0'\left[
        \frac{B_{01}^2}{B_0^2}\dkappaparadT + \dkappaperpdT\oneminusBoneB
      \right]\dhj{5}\hk{5} \\
      &-\int i\gmone \left(2B_{01}^2\kappapfK{0} + \skappaperp{0}\right)\dhj{5}\dhk{5} &\\
    %
    \condmat(5, 6) &=
      - 2i\gmone \eps T_0'\Gmin \kpplusplus \hj{5}\hk{6} \\
      &- \int 2\gmone \eps T_0'\Gmin \kpplus\frac{B_{01}}{B_0^2}\left(
        \frac{\eps'}{\eps}iB_{01} + \Fplus
      \right)\hj{5}\hk{6} \\
      &+ \int 2i\gmone \eps T_0' \Gmin \kpplusplus\dhj{5}\hk{6} &\\
    %
    \condmat(5, 7) &=
      2\gmone k_3 T_0' B_{01}\kpplusplus\hj{5}\hk{7}  \\
      &+ 2i\gmone T_0' B_{03}\kpplusplus\hj{5}\dhk{7} \\
      &+ \int \gmone k_3 \kappapfK{0} \left(B_{01}T_0'' + iT_0'\Fplus\right) \hj{5}\hk{7} \\
      &+ \int \gmone k_3 B_{01}T_0'\left[\kappapfK{0}' - 2i\frac{B_{01}}{B_0^2}\kpplus\left(
        \frac{\eps'}{\eps}iB_{01} + \Fplus
      \right)\right] \hj{5}\hk{7} \\
      &+ \int\gmone T_0' B_{01}\left[2\frac{B_{03}}{B_0^2}\kpplus\left(
        \frac{\eps'}{\eps}iB_{01} + \Fplus
      \right) - k_3\kappapfK{0}\right]\hj{5}\dhk{7} \\
      &- \int 2\gmone T_0' B_{01}k_3\kpplusplus \dhj{5}\hk{7} \\
      &- \int 2i\gmone T_0' B_{03}\kpplusplus \dhj{5}\dhk{7} &\\
    %
    \condmat(5, 8) &=
      -2\gmone B_{01}k_2 T_0' \kpplusplus \hj{5}\hk{8} \\
      &- 2i\gmone B_{02}\eps T_0' \kpplusplus \hj{5}\dhk{8} \\
      &- \int \gmone k_2 \kappapfK{0}\left(B_{01}T_0'' + iT_0'\Fplus\right) \hj{5}\hk{8} \\
      &- \int \gmone k_2 B_{01}T_0'\left[\kappapfK{0}' - 2i\frac{B_{01}}{B_0^2}\kpplus\left(
        \frac{\eps'}{\eps}iB_{01} + \Fplus
      \right)\right] \hj{5}\hk{8} \\
      &- \int \gmone T_0' B_{01} \left[2\frac{\eps B_{02}}{B_0^2}\kpplus \left(
        \frac{\eps'}{\eps}iB_{01} + \Fplus
      \right) - k_2 \kappapfK{0}\right] \hj{5}\dhk{8} \\
      &+ \int 2\gmone T_0' B_{01}k_2 \kpplusplus\dhj{5}\hk{8} \\
      &+ \int 2i\gmone T_0' \eps B_{02}\kpplusplus \dhj{5}\dhk{8} &\\
    %
    \etamat(5, 5) &=
      \int i\gmone \frac{d\eta}{dT}\left[
        \left(\frac{\left(\eps B_{02}\right)'}{\eps}\right)^2 + B_{03}'^2
      \right]\hj{5}\hk{5} &\\
    \etamat(5, 6) &=
      2i\gmone \eta_0 \Bigl(k_3\left(\eps B_{02}\right)' - k_2 B_{03}'\Bigr)\hj{5}\hk{6} \\
      &- \int 2i\gmone \eta_0 \Bigl(k_3\left(\eps B_{02}\right)' - k_2 B_{03}'\Bigr)\dhj{5}\hk{6} \\
      &+ \int 2i\gmone k_2\left[
        B_{03}'\left(\frac{\eps'}{\eps}\eta_0 + \eta_0'\right) + B_{03}'' \eta_0
      \right] \hj{5}\hk{6} \\
      &+ \int 2i\gmone k_3\left[
        \left(\eps B_{02}\right)' \left(\frac{\eps'}{\eps}\eta_0 - \eta_0'\right)
        - \eps \eta_0\left(2\frac{\eps'}{\eps}B_{02}' + B_{02}''\right)
      \right]\hj{5}\hk{6} &\\
    \etamat(5, 7) &=
      2i\gmone \eta_0 B_{03}'\hj{5}\dhk{7}
      - \int 2i\gmone \eta_0 B_{03}'\dhj{5}\dhk{7} \\
      &- \int 2i\gmone \left[B_{03}'\left(
        \frac{\eps'}{\eps}\eta_0 + \eta_0'
      \right) + B_{03}''\eta_0\right]\hj{5}\dhk{7} \\
      &- \int 2i\gmone \eta_0 \left[
        \frac{\left(\eps B_{02}\right)'}{\eps^2}k_2k_3 + B_{03}' k_3^2
      \right]\hj{5}\hk{7} &\\
    \etamat(5, 8) &=
      -2i\gmone \eta_0\left(\eps B_{02}\right)'\hj{5}\dhk{8} \\
      &+ \int 2i\gmone \eta_0\left[\frac{\left(\eps B_{02}\right)'}{\eps^2} k_2^2 + B_{03}'k_2k_3\right]\hj{5}\hk{8} \\
      &- \int 2i\gmone \left[
        \left(\eps B_{02}\right)'\left(\frac{\eps'}{\eps}\eta_0 - \eta_0'\right)
        - \eps\eta_0\left(2\frac{\eps'}{\eps}B_{02}' + B_{02}''\right)
      \right]\hj{5}\dhk{8} \\
      &+ \int 2i\gmone \left(\eps B_{02}\right)'\eta_0 \dhj{5}\dhk{8}
  \end{flalign*}
}

\subsubsection{Matrix elements induction-1 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(6, 6) &= \int \eps \hj{6}\hk{6} &\\
    %
    \amat(6, 3) &= -\int \eps B_{03} \hj{6}\hk{3} &\\
    %
    \amat(6, 4) &= \int B_{02}\hj{6}\hk{4} &\\
    %
    \flowmat(6, 6) &= \int \eps\Fplus\hj{6}\hk{6} &\\
    %
    \flowmat(6, 7) &= -\int v_{02}\hj{6}\dhk{7} &\\
    %
    \flowmat(6, 8) &= -\int \eps v_{03}\hj{6}\dhk{8} &\\
    %
    \etamat(6, 6) &= -\int i \eta_0 \left(\frac{k_2^2}{\eps} + \eps k_3^2\right) \hj{6}\hk{6} &\\
    %
    \etamat(6, 7) &= \int i \eta_0 \frac{k_2}{\eps}\hj{6}\dhk{7} &\\
    %
    \etamat(6, 8) &= \int i \eta_0 \eps k_3  \hj{6}\dhk{8}
  \end{flalign*}
}

\subsubsection{Matrix elements induction-2 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(7, 7) &= \int \hj{7}\hk{7} &\\
    %
    \amat(7, 2) &= -\int B_{03}\hj{7}\hk{2} &\\
    %
    \amat(7, 4) &= \int iB_{01}\hj{7}\hk{4} &\\
    %
    \flowmat(7, 6) &= \int i v_{01}k_2 \hj{7}\hk{6} &\\
    %
    \flowmat(7, 7) &= \int k_3 v_{03} \hj{7}\hk{7} - \int iv_{01}\hj{7}\dhk{7} &\\
    %
    \flowmat(7, 8) &= -\int k_2 v_{03} \hj{7}\hk{8} &\\
    %
    \etamat(7, 5) &= \int iB_{03}'\frac{d\eta}{dT}\hj{7}\hk{5} &\\
    %
    \etamat(7, 6) &=
      -i\eta_0 k_2 \hj{7}\hk{6}
      + \int i k_2 \left(\frac{\eps'}{\eps}\eta_0 + \eta_0'\right)\hj{7}\hk{6}
      + \int i\eta_0 k_2\dhj{7}\hk{6} &\\
    %
    \etamat(7, 7) &=
      i\eta_0 \hj{7}\dhk{7}
      - \int i\eta_0 k_3^2\hj{7}\hk{7}
      - \int i\left(\frac{\eps'}{\eps}\eta_0 + \eta_0'\right)\hj{7}\dhk{7}
      - \int i\eta_0 \dhj{7}\dhk{7} &\\
    %
    \etamat(7, 8) &= \int i\eta_0 k_2 k_3 \hj{7}\hk{8}
  \end{flalign*}
}

\subsubsection{Matrix elements induction-3 equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(8, 8) &= \int \eps \hj{8}\hk{8} &\\
    %
    \amat(8, 2) &= \int B_{02}\hj{8}\hk{2} &\\
    %
    \amat(8, 3) &= -\int i \eps B_{01} \hj{8}\hk{3} &\\
    %
    \flowmat(8, 6) &= \int \eps k_3 iv_{01}\hj{8}\hk{6} &\\
    %
    \flowmat(8, 7) &= -\int k_3 v_{02}\hj{8}\hk{7} &\\
    %
    \flowmat(8, 8) &= \int k_2 v_{02}\hj{8}\hk{8} - \int iv_{01}\hj{8}\dhk{8} &\\
    %
    \etamat(8, 5) &= -\int i\frac{\left(\eps B_{02}\right)'}{\eps}\frac{d\eta}{dT}\hj{8}\hk{5} &\\
    %
    \etamat(8, 6) &=
      -i\eta_0 \eps k_3 \hj{8}\hk{6}
      + \int i\eta_0' \eps k_3 \hj{8}\hk{6}
      + \int i\eta_0 \eps k_3 \dhj{8}\hk{6} &\\
    %
    \etamat(8, 7) &= \int i\eta_0 \frac{k_2 k_3}{\eps}\hj{8}\hk{7} &\\
    %
    \etamat(8, 8) &=
      i\eta_0 \eps \hj{8}\dhk{8}
      - \int i\eta_0 \frac{k_2^2}{\eps}\hj{8}\hk{8}
      - \int i\eta_0'\eps \hj{8}\dhk{8}
      - \int i\eta_0 \eps \dhj{8}\dhk{8}
    %
  \end{flalign*}
}

\subsubsection{Matrix elements selfgravity equation}
{
  \customEquationFont
  \allowdisplaybreaks
  \begin{flalign*}
    \bmat(9, 9) &=
      \eps\hj{9}\dhk{9}
      - \int \eps \dhj{9}\dhk{9}
      - \int \left(\frac{k_2^2}{\eps}
      + \eps k_3^2\right) \hj{9}\hk{9} &\\
    %
    \amat(9, 2) &= -4\pi\int \rho_0'\hj{9}\hk{2} - 4\pi \int\rho_0 \hj{9}\dhk{2} &\\
    %
    \amat(9, 3) &= 4\pi\int \rho_0 k_2 \hj{9}\hk{3} &\\
    %
    \amat(9, 4) &= 4\pi \int \rho_0 k_3 \hj{9}\hk{4} &\\
    %
    \flowmat(9, 1) &= 4\pi \int \Bigl(\Vplus - iv_{01}'\Bigr)\hj{9}\hk{1} - 4\pi G \int iv_{01}\hj{9}\dhk{1} &
  \end{flalign*}
}
\cleardoublepage